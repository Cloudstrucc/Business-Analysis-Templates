<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-1">Manage Invites</h1>
      <p class="text-muted mb-0">Create and manage client questionnaire invitations</p>
    </div>
    <a href="/admin/invites/new" class="btn btn-primary">
      <i class="bi bi-plus-lg me-2"></i>Create New Invite
    </a>
  </div>
  
  <!-- Filters -->
  <div class="card mb-4">
    <div class="card-body">
      <form action="/admin/invites" method="GET" class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label">Status</label>
          <select class="form-select" name="status">
            <option value="">All Statuses</option>
            <option value="active" {{#eq filters.status "active"}}selected{{/eq}}>Active</option>
            <option value="expired" {{#eq filters.status "expired"}}selected{{/eq}}>Expired</option>
            <option value="revoked" {{#eq filters.status "revoked"}}selected{{/eq}}>Revoked</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Search</label>
          <input type="text" class="form-control" name="search" value="{{filters.search}}" placeholder="Client name or email...">
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-outline-primary w-100">
            <i class="bi bi-search me-1"></i>Filter
          </button>
        </div>
        {{#if filters.status}}
          <div class="col-md-2">
            <a href="/admin/invites" class="btn btn-outline-secondary w-100">Clear Filters</a>
          </div>
        {{/if}}
      </form>
    </div>
  </div>
  
  <!-- Invites Table -->
  <div class="card">
    <div class="card-body p-0">
      {{#if invites.length}}
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead>
              <tr>
                <th>Client</th>
                <th>Forms</th>
                <th>Code</th>
                <th>Status</th>
                <th>Created</th>
                <th>Expires</th>
                <th>Progress</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              {{#each invites}}
                <tr>
                  <td>
                    <strong>{{this.client_name}}</strong>
                    <br><small class="text-muted">{{this.client_email}}</small>
                    {{#if this.client_company}}
                      <br><small class="text-muted">{{this.client_company}}</small>
                    {{/if}}
                  </td>
                  <td>
                    <span class="badge bg-info">{{this.form_count}} form(s)</span>
                  </td>
                  <td>
                    <code class="user-select-all">{{this.code}}</code>
                  </td>
                  <td>
                    {{#if this.is_revoked}}
                      <span class="badge bg-secondary">Revoked</span>
                    {{else}}
                      {{#if this.is_expired}}
                        <span class="badge bg-danger">Expired</span>
                      {{else}}
                        <span class="badge bg-success">Active</span>
                      {{/if}}
                    {{/if}}
                  </td>
                  <td><small>{{this.created_at}}</small></td>
                  <td><small>{{this.expires_at}}</small></td>
                  <td>
                    <div class="progress" style="width: 80px; height: 6px;">
                      <div class="progress-bar" style="width: {{this.progress}}%"></div>
                    </div>
                    <small class="text-muted">{{this.progress}}%</small>
                  </td>
                  <td class="text-end">
                    <div class="btn-group btn-group-sm">
                      <a href="/admin/invites/{{this.id}}" class="btn btn-outline-primary" title="View Details">
                        <i class="bi bi-eye"></i>
                      </a>
                      
                      {{#if this.is_revoked}}
                        {{!-- Revoked: Show Re-activate and Delete buttons --}}
                        <button type="button" class="btn btn-outline-success" title="Re-activate & Send Email"
                          onclick="reactivateInvite('{{this.id}}', '{{this.client_name}}')">
                          <i class="bi bi-arrow-counterclockwise"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger" title="Delete Permanently"
                          onclick="deleteInvite('{{this.id}}', '{{this.client_name}}')">
                          <i class="bi bi-trash"></i>
                        </button>
                        
                      {{else if this.is_expired}}
                        {{!-- Expired: Show Re-activate and Delete buttons --}}
                        <button type="button" class="btn btn-outline-success" title="Re-activate & Send Email"
                          onclick="reactivateInvite('{{this.id}}', '{{this.client_name}}')">
                          <i class="bi bi-arrow-counterclockwise"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger" title="Delete Permanently"
                          onclick="deleteInvite('{{this.id}}', '{{this.client_name}}')">
                          <i class="bi bi-trash"></i>
                        </button>
                        
                      {{else}}
                        {{!-- Active: Show Copy Link, Resend, and Revoke buttons --}}
                        <button type="button" class="btn btn-outline-secondary" title="Copy Link" 
                          onclick="copyInviteLink('{{this.code}}')">
                          <i class="bi bi-link-45deg"></i>
                        </button>
                        <button type="button" class="btn btn-outline-warning" title="Resend Email"
                          onclick="resendInvite('{{this.id}}')">
                          <i class="bi bi-envelope"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger" title="Revoke"
                          onclick="revokeInvite('{{this.id}}', '{{this.client_name}}')">
                          <i class="bi bi-x-circle"></i>
                        </button>
                      {{/if}}
                    </div>
                  </td>
                </tr>
              {{/each}}
            </tbody>
          </table>
        </div>
      {{else}}
        <div class="text-center py-5">
          <i class="bi bi-envelope-paper fs-1 text-muted"></i>
          <p class="text-muted mt-3">No invites found</p>
          <a href="/admin/invites/new" class="btn btn-primary">
            <i class="bi bi-plus-lg me-2"></i>Create First Invite
          </a>
        </div>
      {{/if}}
    </div>
  </div>
</div>

<!-- Revoke Modal -->
<div class="modal fade" id="revokeModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Revoke Invite</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to revoke the invite for <strong id="revokeClientName"></strong>?</p>
        <p class="text-muted small">This action cannot be undone. The client will no longer be able to access their questionnaire.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form id="revokeForm" method="POST" style="display: inline;">
          <button type="submit" class="btn btn-danger">Revoke Invite</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Re-activate Modal -->
<div class="modal fade" id="reactivateModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Re-activate Invite</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Re-activate the invite for <strong id="reactivateClientName"></strong>?</p>
        <p class="text-muted small">This will set the status to Active, extend the expiry date, and send a new email with the form link to the client.</p>
        <div class="mt-3">
          <label class="form-label">New Expiry (days from now)</label>
          <select class="form-select" id="reactivateExpiry">
            <option value="7">7 days</option>
            <option value="14" selected>14 days</option>
            <option value="30">30 days</option>
            <option value="60">60 days</option>
            <option value="90">90 days</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" onclick="confirmReactivate()">
          <i class="bi bi-arrow-counterclockwise me-1"></i>Re-activate & Send Email
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header border-danger">
        <h5 class="modal-title text-danger"><i class="bi bi-exclamation-triangle me-2"></i>Delete Invite</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to <strong class="text-danger">permanently delete</strong> the invite for <strong id="deleteClientName"></strong>?</p>
        <div class="alert alert-danger small">
          <i class="bi bi-exclamation-triangle me-1"></i>
          <strong>Warning:</strong> This will permanently remove the invite and all associated form responses from the database. This action cannot be undone.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form id="deleteForm" method="POST" style="display: inline;">
          <button type="submit" class="btn btn-danger">
            <i class="bi bi-trash me-1"></i>Delete Permanently
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
let reactivateInviteId = null;

function copyInviteLink(code) {
  const link = window.location.origin + '/form/' + code;
  navigator.clipboard.writeText(link).then(() => {
    alert('Invite link copied to clipboard!');
  });
}

function resendInvite(id) {
  if (confirm('Resend invite email?')) {
    fetch('/admin/invites/' + id + '/resend', { method: 'POST' })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert('Invite email resent successfully!');
        } else {
          alert('Failed to resend email: ' + (data.message || 'Unknown error'));
        }
      });
  }
}

function revokeInvite(id, clientName) {
  document.getElementById('revokeClientName').textContent = clientName;
  document.getElementById('revokeForm').action = '/admin/invites/' + id + '/revoke';
  new bootstrap.Modal(document.getElementById('revokeModal')).show();
}

function reactivateInvite(id, clientName) {
  reactivateInviteId = id;
  document.getElementById('reactivateClientName').textContent = clientName;
  document.getElementById('reactivateExpiry').value = '14'; // Reset to default
  new bootstrap.Modal(document.getElementById('reactivateModal')).show();
}

function confirmReactivate() {
  const expiryDays = document.getElementById('reactivateExpiry').value;
  
  fetch('/admin/invites/' + reactivateInviteId + '/reactivate', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ expiry_days: parseInt(expiryDays) })
  })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        bootstrap.Modal.getInstance(document.getElementById('reactivateModal')).hide();
        alert('Invite re-activated and email sent successfully!');
        window.location.reload();
      } else {
        alert('Failed to re-activate invite: ' + (data.message || 'Unknown error'));
      }
    })
    .catch(err => {
      alert('Error: ' + err.message);
    });
}

function deleteInvite(id, clientName) {
  document.getElementById('deleteClientName').textContent = clientName;
  document.getElementById('deleteForm').action = '/admin/invites/' + id + '/delete';
  new bootstrap.Modal(document.getElementById('deleteModal')).show();
}
</script>